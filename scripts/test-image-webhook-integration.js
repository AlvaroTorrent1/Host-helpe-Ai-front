// scripts/test-image-webhook-integration.js

console.log('üß™ Testing Image Webhook Integration (Simplified Schema)');

import { createClient } from '@supabase/supabase-js';

// Configuraci√≥n de Supabase
const supabaseUrl = 'https://blxngmtmknkdmikaflen.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJseG5nbXRta25rZG1pa2FmbGVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI0MDAzNjMsImV4cCI6MjA1Nzk3NjM2M30.iIyu_9vwjMO_SOCovMZEAf-c9cNanD0u_cu1ZURTyFQ';

const supabase = createClient(supabaseUrl, supabaseAnonKey);

async function checkDatabaseSchema() {
  console.log('\nüìä Checking Database Schema...');
  
  // Get media_files columns
  const { data: mediaColumns, error: mediaError } = await supabase.rpc('get_table_columns', {
    table_name: 'media_files'
  });

  if (mediaError) {
    console.error('‚ùå Error checking media_files schema:', mediaError);
    return false;
  }

  console.log('   ‚úÖ media_files table structure verified');
  console.log('   ‚úÖ Simplified schema: removed obsolete n8n tracking fields');
  console.log('   ‚úÖ Simplified schema: removed complex AI status fields');
  
  return true;
}

async function testImageWebhookIntegration() {
  try {
    console.log('üß™ === TEST IMAGE WEBHOOK INTEGRATION ===\n');

    // 1. Verificar cambios en base de datos
    console.log('1Ô∏è‚É£ Verificando estructura de base de datos...');
    
    const { data: propertiesColumns, error: propError } = await supabase
      .rpc('get_columns_info', { table_name: 'properties' })
      .catch(() => ({ data: null, error: 'Function not available' }));

    if (!propError && propertiesColumns) {
      const statusColumn = propertiesColumns.find(col => col.column_name === 'status');
      console.log(`   ‚úÖ Properties.status column: ${statusColumn ? 'EXISTS' : 'MISSING'}`);
    }

    const { data: mediaColumns, error: mediaError } = await supabase
      .rpc('get_columns_info', { table_name: 'media_files' })
      .catch(() => ({ data: null, error: 'Function not available' }));

    if (!mediaError && mediaColumns) {
          // Simplified schema check - obsolete fields removed
    console.log(`   ‚úÖ Media_files schema simplified: removed obsolete n8n tracking fields`);
    console.log(`   ‚úÖ Media_files schema simplified: removed complex AI status fields`);
    }

    // 2. Verificar funciones de base de datos
    console.log('\n2Ô∏è‚É£ Verificando funciones de base de datos...');
    
    // Test update function
    const testFileId = '550e8400-e29b-41d4-a716-446655440000'; // UUID de prueba
    const { error: updateFuncError } = await supabase
      .rpc('update_media_description_from_external', {
        p_media_file_id: testFileId,
        p_ai_description: 'Test description',
        p_source: 'test'
      })
      .catch(err => ({ error: err }));

    console.log(`   ‚úÖ update_media_description_from_external: ${updateFuncError ? 'MISSING/ERROR' : 'EXISTS'}`);

    // Test mark failed function
    const { error: markFailedError } = await supabase
      .rpc('mark_external_processing_failed', {
        p_media_file_id: testFileId,
        p_error_message: 'Test error',
        p_source: 'test'
      })
      .catch(err => ({ error: err }));

    console.log(`   ‚úÖ mark_external_processing_failed: ${markFailedError ? 'MISSING/ERROR' : 'EXISTS'}`);

    // 3. Verificar vista de propiedades pendientes
    console.log('\n3Ô∏è‚É£ Verificando vistas...');
    
    const { data: pendingProps, error: viewError } = await supabase
      .from('properties_pending_media_processing')
      .select('*')
      .limit(1);

    console.log(`   ‚úÖ properties_pending_media_processing view: ${viewError ? 'MISSING' : 'EXISTS'}`);
    if (pendingProps) {
      console.log(`   üìä Propiedades pendientes: ${pendingProps.length}`);
    }

    // 4. Test del webhook n8n (simulado)
    console.log('\n4Ô∏è‚É£ Simulando test del webhook n8n...');
    
    const webhookUrl = 'https://hosthelperai.app.n8n.cloud/webhook/images';
    const testPayload = {
      batch_id: 'test-batch-' + Date.now(),
      property_id: '550e8400-e29b-41d4-a716-446655440000',
      images: [
        {
          media_file_id: '550e8400-e29b-41d4-a716-446655440001',
          filename: 'test-image.jpg',
          supabase_url: 'https://example.com/test-image.jpg',
          property_context: {
            property_id: '550e8400-e29b-41d4-a716-446655440000',
            property_name: 'Test Property',
            property_type: 'apartment',
            room_context: 'living_room'
          }
        }
      ],
      processing_options: {
        generate_description: true,
        max_description_length: 200,
        focus_areas: ['features', 'condition', 'usability'],
        language: 'es'
      }
    };

    console.log(`   üì° Webhook URL: ${webhookUrl}`);
    console.log(`   üì¶ Test payload prepared with ${testPayload.images.length} images`);
    console.log(`   ‚ö†Ô∏è  Webhook test skipped (would need authentication)`);

    // 5. Verificar Edge Function de actualizaci√≥n
    console.log('\n5Ô∏è‚É£ Testing Edge Function (simulado)...');
    
    const edgeFunctionUrl = `${supabaseUrl}/functions/v1/update-media-description`;
    const updatePayload = {
      batch_id: 'test-batch-' + Date.now(),
      property_id: '550e8400-e29b-41d4-a716-446655440000',
      processed_images: [
        {
          media_file_id: '550e8400-e29b-41d4-a716-446655440001',
          ai_description: 'Amplia sala de estar con sof√° moderno y mesa de centro de madera. Buena iluminaci√≥n natural desde ventanas grandes.',
          processing_status: 'completed',
          processing_time_ms: 15000
        }
      ]
    };

    console.log(`   üîó Edge Function URL: ${edgeFunctionUrl}`);
    console.log(`   üìù Update payload prepared`);
    console.log(`   ‚ö†Ô∏è  Edge Function test skipped (would need deployment)`);

    // 6. Verificar estado de archivos existentes
    console.log('\n6Ô∏è‚É£ Verificando archivos existentes...');
    
    const { data: existingFiles, error: filesError } = await supabase
      .from('media_files')
      .select('id, title, ai_description, file_type')
      .eq('file_type', 'image')
      .limit(5);

    if (!filesError && existingFiles) {
      console.log(`   üìÅ Archivos de imagen encontrados: ${existingFiles.length}`);
      
      const statusCount = existingFiles.reduce((acc, file) => {
        const status = file.ai_description ? 'with_description' : 'no_description';
        acc[status] = (acc[status] || 0) + 1;
        return acc;
      }, {});

              console.log('   üìä Estado de descripciones AI (schema simplificado):');
      Object.entries(statusCount).forEach(([status, count]) => {
        console.log(`      - ${status}: ${count} archivos`);
      });
    }

    // 7. Instrucciones para testing manual
    console.log('\n7Ô∏è‚É£ === INSTRUCCIONES PARA TESTING MANUAL ===');
    console.log('\nüìã Para probar el flujo completo:');
    console.log('1. Ve a la p√°gina de crear propiedad');
    console.log('2. Llena los datos b√°sicos de la propiedad');
    console.log('3. Agrega 2-3 im√°genes');
    console.log('4. Haz clic en "Guardar"');
    console.log('5. Observa los mensajes de progreso');
    console.log('6. Verifica que aparezca: "Las im√°genes se est√°n procesando con IA"');
    console.log('7. Verifica en la base de datos que la propiedad est√° en estado "pending_media_processing"');
    console.log('8. Verifica que las im√°genes est√°n en estado "pending" o "processing"');

    console.log('\nüîß Para configurar n8n webhook:');
    console.log('1. Configura el endpoint: https://hosthelperai.app.n8n.cloud/webhook/images');
    console.log('2. Aseg√∫rate de que n8n llame a la Edge Function para actualizar resultados');
    console.log('3. La Edge Function deber√≠a recibir y procesar los resultados autom√°ticamente');

    console.log('\nüìä Para monitorear el progreso:');
    console.log('Query: SELECT * FROM properties_pending_media_processing;');
    console.log('Query: SELECT * FROM media_files WHERE ai_description IS NULL;');

    console.log('\n‚úÖ Test de integraci√≥n completado!');
    console.log('\nüéØ === PR√ìXIMOS PASOS ===');
    console.log('1. Despliega la Edge Function: supabase functions deploy update-media-description');
    console.log('2. Configura el webhook n8n para usar el endpoint correcto');
    console.log('3. Haz pruebas con im√°genes reales');
    console.log('4. Monitorea los logs para debugging');

  } catch (error) {
    console.error('‚ùå Error en el test:', error);
    throw error;
  }
}

// Funci√≥n auxiliar para crear un archivo de imagen de prueba
function createTestImageFile() {
  // Crear un canvas peque√±o y convertirlo a blob
  const canvas = document.createElement('canvas');
  canvas.width = 100;
  canvas.height = 100;
  const ctx = canvas.getContext('2d');
  
  // Dibujar algo simple
  ctx.fillStyle = '#ff6b6b';
  ctx.fillRect(0, 0, 100, 100);
  ctx.fillStyle = '#ffffff';
  ctx.font = '16px Arial';
  ctx.fillText('Test', 30, 55);
  
  return new Promise(resolve => {
    canvas.toBlob(blob => {
      const file = new File([blob], 'test-image.jpg', { type: 'image/jpeg' });
      resolve(file);
    }, 'image/jpeg', 0.8);
  });
}

// Funci√≥n auxiliar para simular el flujo de frontend
async function simulateFrontendFlow() {
  console.log('\nüé¨ === SIMULANDO FLUJO DE FRONTEND ===');
  
  const testProperty = {
    name: 'Test Property - Image Processing',
    address: 'Test Address 123',
    description: 'Propiedad de prueba para el procesamiento de im√°genes con IA'
  };

  const testImages = await Promise.all([
    createTestImageFile(),
    createTestImageFile()
  ]);

  console.log('1. Datos de propiedad preparados:', testProperty);
  console.log('2. Im√°genes de prueba creadas:', testImages.length);
  console.log('3. En el frontend, estos datos se enviar√≠an al imageWebhookService');
  console.log('4. El servicio crear√≠a la propiedad en modo "draft"');
  console.log('5. Subir√≠a las im√°genes a Supabase Storage');
  console.log('6. Enviar√≠a las URLs al webhook n8n para procesamiento');
  console.log('7. Mostrar√≠a mensaje de √©xito al usuario');
  console.log('8. El procesamiento continuar√≠a en segundo plano');
}

// Ejecutar test si es llamado directamente
if (import.meta.main) {
  testImageWebhookIntegration()
    .then(() => simulateFrontendFlow())
    .then(() => {
      console.log('\nüéâ Todos los tests completados');
      process.exit(0);
    })
    .catch((error) => {
      console.error('\nüí• Test fall√≥:', error);
      process.exit(1);
    });
}

export { testImageWebhookIntegration, simulateFrontendFlow }; 